<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pirs.hli.mcnp.interface &mdash; PIRS manual 1.1a documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.1a',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="PIRS manual 1.1a documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">PIRS manual 1.1a documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pirs.hli.mcnp.interface</h1><div class="highlight"><pre>
<span class="c">#at</span>
<span class="c"># Author: Anton Travleev, anton.travleev@kit.edu</span>
<span class="c"># Developed at INR, Karlsruhe Institute of Technology</span>
<span class="c">#at</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c"># for results of &#39;dry run&#39;</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">cos</span><span class="p">,</span> <span class="n">pi</span> 
<span class="kn">import</span> <span class="nn">random</span> 

<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">mcnp</span>
<span class="kn">from</span> <span class="nn">...solids</span> <span class="kn">import</span> <span class="n">Sphere</span><span class="p">,</span> <span class="n">Box</span><span class="p">,</span> <span class="n">Cylinder</span>
<span class="kn">from</span> <span class="nn">.convertors</span> <span class="kn">import</span> <span class="n">solid2surface</span><span class="p">,</span> <span class="n">solid2volume</span><span class="p">,</span> <span class="n">zmesh2volumes</span><span class="p">,</span> <span class="n">zmesh2mtally</span><span class="p">,</span> <span class="n">grid2tally</span><span class="p">,</span> <span class="n">base_element2volume</span>
<span class="kn">from</span> <span class="nn">...core</span> <span class="kn">import</span> <span class="n">scheduler</span>

<span class="n">_LOG</span> <span class="o">=</span> <span class="bp">False</span> <span class="c">#True</span>

<span class="k">class</span> <span class="nc">McnpInterface</span><span class="p">(</span><span class="n">mcnp</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<div class="viewcode-block" id="McnpInterface"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface">[docs]</a>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    McnpInterface is an MCNP model with ability to take an instance of one of the</span>
<span class="sd">    solids classes as input data.</span>

<span class="sd">    Simple box and cylinder</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(Box())</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1  $ model</span>
<span class="sd">    2 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rpp  -0.5  0.5  -0.5  0.5  -0.5  0.5</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(Cylinder())</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1  $ model</span>
<span class="sd">    2 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rcc  0.0  0.0  -0.5  0.0  0.0  1.0  1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    Box and cylinder with axially distributed density. Note that not only mesh</span>
<span class="sd">    itself must be set, but also the values, so the density is not constant:</span>

<span class="sd">    &gt;&gt;&gt; s1 = Box()</span>
<span class="sd">    &gt;&gt;&gt; s1.dens.set_grid([1]*4)</span>
<span class="sd">    &gt;&gt;&gt; s1.dens.set_values([1.1, 1.2, 1.3, 1.4])</span>
<span class="sd">    &gt;&gt;&gt; s1.material = &#39;fuel&#39;</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(s1)</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1 fill=1  $ model</span>
<span class="sd">    2 1 -1.1 2 -3 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    3 1 -1.2 3 -4 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    4 1 -1.3 4 -5 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    5 1 -1.4 5 -6 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    6 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rpp  -0.5  0.5  -0.5  0.5  -0.5  0.5</span>
<span class="sd">    2 pz  -1000.5</span>
<span class="sd">    3 pz  -0.25</span>
<span class="sd">    4 pz  0.0</span>
<span class="sd">    5 pz  0.25</span>
<span class="sd">    6 pz  1000.5</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    m1 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    &gt;&gt;&gt; s1 = Cylinder()</span>
<span class="sd">    &gt;&gt;&gt; s1.dens.set_grid([1]*4)</span>
<span class="sd">    &gt;&gt;&gt; s1.dens.set_values([1.1, 1.2, 1.3, 1.4])</span>
<span class="sd">    &gt;&gt;&gt; s1.material = &#39;fuel&#39;</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(s1)</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1 fill=1  $ model</span>
<span class="sd">    2 1 -1.1 2 -3 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    3 1 -1.2 3 -4 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    4 1 -1.3 4 -5 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    5 1 -1.4 5 -6 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    6 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rcc  0.0  0.0  -0.5  0.0  0.0  1.0  1.0</span>
<span class="sd">    2 pz  -1000.5</span>
<span class="sd">    3 pz  -0.25</span>
<span class="sd">    4 pz  0.0</span>
<span class="sd">    5 pz  0.25</span>
<span class="sd">    6 pz  1000.5</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    m1 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>


<span class="sd">    The temperature mesh:</span>

<span class="sd">    &gt;&gt;&gt; b = Box()</span>
<span class="sd">    &gt;&gt;&gt; b.material = &#39;fuel&#39;</span>
<span class="sd">    &gt;&gt;&gt; b.temp.set_grid([1]*5)</span>
<span class="sd">    &gt;&gt;&gt; b.temp.set_values([300, 320, 340, 400, 420])</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(b)</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1 fill=1  $ model</span>
<span class="sd">    2 1 -1.0 2 -3 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    3 2 -1.0 3 -4 imp:n=1 tmp=2.75754976e-08 u=1  $ comment</span>
<span class="sd">    4 3 -1.0 4 -5 imp:n=1 tmp=2.92989662e-08 u=1  $ comment</span>
<span class="sd">    5 4 -1.0 5 -6 imp:n=1 tmp=3.4469372e-08 u=1  $ comment</span>
<span class="sd">    6 5 -1.0 6 -7 imp:n=1 tmp=3.61928406e-08 u=1  $ comment</span>
<span class="sd">    7 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rpp  -0.5  0.5  -0.5  0.5  -0.5  0.5</span>
<span class="sd">    2 pz  -1000.5</span>
<span class="sd">    3 pz  -0.3</span>
<span class="sd">    4 pz  -0.1</span>
<span class="sd">    5 pz  0.1</span>
<span class="sd">    6 pz  0.3</span>
<span class="sd">    7 pz  1000.5</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    m1 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    m2 $ mixture  H-001 at 320.0 K </span>
<span class="sd">         1001.31c 0.788017730687     1001.32c 0.211982269313 $ 0.788017730687 parts of 299.999663469K and 0.211982269313 parts of 400.007287629K</span>
<span class="sd">    m3 $ mixture  H-001 at 340.0 K </span>
<span class="sd">         1001.31c 0.5825662186     1001.32c 0.4174337814 $ 0.5825662186 parts of 299.999663469K and 0.4174337814 parts of 400.007287629K</span>
<span class="sd">    m4 $ mixture  H-001 at 400.0 K </span>
<span class="sd">         1001.32c 1.0</span>
<span class="sd">    m5 $ mixture  H-001 at 420.0 K </span>
<span class="sd">         1001.32c 0.790847540923     1001.33c 0.209152459077 $ 0.790847540923 parts of 400.007287629K and 0.209152459077 parts of 500.003307284K</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>

<span class="sd">    model consisting of several solids, each with its own material:</span>

<span class="sd">    &gt;&gt;&gt; b = Box()</span>
<span class="sd">    &gt;&gt;&gt; b.X = 10</span>
<span class="sd">    &gt;&gt;&gt; b.Y = 10 </span>
<span class="sd">    &gt;&gt;&gt; b.Z = 100</span>
<span class="sd">    &gt;&gt;&gt; c = b.insert(1, Cylinder())</span>
<span class="sd">    &gt;&gt;&gt; c.R = 1</span>
<span class="sd">    &gt;&gt;&gt; c.Z = b.Z</span>
<span class="sd">    &gt;&gt;&gt; b.material = &#39;water&#39;</span>
<span class="sd">    &gt;&gt;&gt; c.material = &#39;pin&#39;</span>
<span class="sd">    &gt;&gt;&gt; print McnpInterface(b)</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1 fill=1  $ model</span>
<span class="sd">    2 1 -1.0 2 -3 (4:1.5:1.6) imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    3 2 -1.0 -4 -1.5 -1.6 imp:n=1 u=1 tmp=2.5852029e-08  $ 1</span>
<span class="sd">    4 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rpp  -5.0  5.0  -5.0  5.0  -50.0  50.0</span>
<span class="sd">    2 pz  -1005.0</span>
<span class="sd">    3 pz  1005.0</span>
<span class="sd">    4 cz  1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    m1 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    m2 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>


<span class="sd">    A more complex model consisting of several solids and with density and</span>
<span class="sd">    temperature distributions.</span>

<span class="sd">    &gt;&gt;&gt; b = Box()</span>
<span class="sd">    &gt;&gt;&gt; b.set_radius(10.)</span>
<span class="sd">    &gt;&gt;&gt; b.material = &#39;m1&#39;</span>
<span class="sd">    &gt;&gt;&gt; c1 = b.insert(1, Cylinder())</span>
<span class="sd">    &gt;&gt;&gt; c2 = b.insert(2, Cylinder())</span>
<span class="sd">    &gt;&gt;&gt; c3 = b.insert(3, Cylinder())</span>
<span class="sd">    &gt;&gt;&gt; c1.pos.z = -5</span>
<span class="sd">    &gt;&gt;&gt; c2.pos.z =  0</span>
<span class="sd">    &gt;&gt;&gt; c3.pos.z =  5</span>
<span class="sd">    &gt;&gt;&gt; b.dens.set_grid([1,1,1])</span>
<span class="sd">    &gt;&gt;&gt; b.dens.set_values( [1, 2, 3] )</span>
<span class="sd">    &gt;&gt;&gt; b.temp.set_grid([1,1,1, 1, 1, 1])</span>
<span class="sd">    &gt;&gt;&gt; b.temp.set_values( [300, 320, 340, 360, 420, 400.] )</span>
<span class="sd">    &gt;&gt;&gt; m = McnpInterface(b)</span>
<span class="sd">    &gt;&gt;&gt; print m</span>
<span class="sd">    MESSAGE:</span>
<span class="sd">         datapath=C:\Python27\lib\site-packages\mcnp</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c title</span>
<span class="sd">    1 0  -1 imp:n=1 fill=1  $ model</span>
<span class="sd">    2 1 -1 2 -3 imp:n=1 tmp=2.5852029e-08 u=1  $ comment</span>
<span class="sd">    3 2 -1 3 -4 5 imp:n=1 tmp=2.75754976e-08 u=1  $ comment</span>
<span class="sd">    4 3 -2 4 -6 (5.1:7:-8) imp:n=1 tmp=2.92989662e-08 u=1  $ comment</span>
<span class="sd">    5 4 -2 6 -9 (5.1:7:-8) imp:n=1 tmp=3.10224348e-08 u=1  $ comment</span>
<span class="sd">    6 5 -3 9 -10 (5.1:11:-12) imp:n=1 tmp=3.61928406e-08 u=1  $ comment</span>
<span class="sd">    7 6 -3 10 -13 imp:n=1 tmp=3.4469372e-08 u=1  $ comment</span>
<span class="sd">    8 0  -5 imp:n=1 u=1  $ 1</span>
<span class="sd">    9 0  -5.1 -7 8 imp:n=1 u=1  $ 2</span>
<span class="sd">    10 0  -5.1 -11 12 imp:n=1 u=1  $ 3</span>
<span class="sd">    11 0  1 imp:n=0  $ The other world</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c surfaces</span>
<span class="sd">    1 rpp  -10.0  10.0  -10.0  10.0  -10.0  10.0</span>
<span class="sd">    2 pz  -1010.0</span>
<span class="sd">    3 pz  -6.666666667</span>
<span class="sd">    4 pz  -3.333333333</span>
<span class="sd">    5 rcc  0.0  0.0  -5.5  0.0  0.0  1.0  1.0</span>
<span class="sd">    6 pz  0.0</span>
<span class="sd">    7 pz  0.5</span>
<span class="sd">    8 pz  -0.5</span>
<span class="sd">    9 pz  3.333333333</span>
<span class="sd">    10 pz  6.666666667</span>
<span class="sd">    11 pz  5.5</span>
<span class="sd">    12 pz  4.5</span>
<span class="sd">    13 pz  1010.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    c data cards</span>
<span class="sd">    c materials</span>
<span class="sd">    m1 $ mixture  H-001 at 300.0 K </span>
<span class="sd">         1001.31c 1.0</span>
<span class="sd">    m2 $ mixture  H-001 at 320.0 K </span>
<span class="sd">         1001.31c 0.788017730687     1001.32c 0.211982269313 $ 0.788017730687 parts of 299.999663469K and 0.211982269313 parts of 400.007287629K</span>
<span class="sd">    m3 $ mixture  H-001 at 340.0 K </span>
<span class="sd">         1001.31c 0.5825662186     1001.32c 0.4174337814 $ 0.5825662186 parts of 299.999663469K and 0.4174337814 parts of 400.007287629K</span>
<span class="sd">    m4 $ mixture  H-001 at 360.0 K </span>
<span class="sd">         1001.31c 0.383073636439     1001.32c 0.616926363561 $ 0.383073636439 parts of 299.999663469K and 0.616926363561 parts of 400.007287629K</span>
<span class="sd">    m5 $ mixture  H-001 at 420.0 K </span>
<span class="sd">         1001.32c 0.790847540923     1001.33c 0.209152459077 $ 0.790847540923 parts of 400.007287629K and 0.209152459077 parts of 500.003307284K</span>
<span class="sd">    m6 $ mixture  H-001 at 400.0 K </span>
<span class="sd">         1001.32c 1.0</span>
<span class="sd">    &lt;BLANKLINE&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gm</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__uC</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">auxiliary</span><span class="o">.</span><span class="n">counters</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># universe counter.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span> <span class="o">=</span> <span class="n">gm</span> <span class="c"># general model to be converted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># dictionary for material names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span><span class="p">[</span><span class="s">&#39;void&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdefa</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="mi">1001</span><span class="p">)</span> <span class="c"># default material</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mdefd</span> <span class="o">=</span> <span class="mf">1.0e-5</span> <span class="c"># default material density</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;axial&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;radial&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">McnpInterface</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">materials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="McnpInterface.materials"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface.materials">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary to define the actual meaning of the  material names used in</span>
<span class="sd">        the general model.  Keys are strings with material names from the</span>
<span class="sd">        general model, values are instances of mcnp.Material class.</span>

<span class="sd">        Note that instances of mcnp.Material class have their own property T</span>
<span class="sd">        (temperature). This property is not used. The temperature is defined in</span>
<span class="sd">        the temp property of each element of the general model.</span>

<span class="sd">        Note also that each instance of the mcnp.Material class has its own</span>
<span class="sd">        xsdir property.  This will be replaced with the xsdir property set to</span>
<span class="sd">        the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span>

    <span class="nd">@property</span></div>
    <span class="k">def</span> <span class="nf">bc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="McnpInterface.bc"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface.bc">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary specifying boundary conditions on the axial and radial</span>
<span class="sd">        boundaries of the model.</span>

<span class="sd">        Two keys are meaningful: &#39;axial&#39; and &#39;radial&#39;. Values can be one of &#39;&#39;</span>
<span class="sd">        , &#39;*&#39; and &#39;+&#39; meaning no reflection, mirror and white reflection,</span>
<span class="sd">        respectively.</span>

<span class="sd">        &gt;&gt;&gt; b = Cylinder()</span>
<span class="sd">        &gt;&gt;&gt; m = McnpInterface(b)</span>
<span class="sd">        &gt;&gt;&gt; m.bc[&#39;axial&#39;] = &#39;*&#39;</span>
<span class="sd">        &gt;&gt;&gt; print m     #doctest: +ELLIPSIS</span>
<span class="sd">        ...</span>
<span class="sd">        1 0  -3 -2 1 imp:n=1  $ model</span>
<span class="sd">        2 0  3:2:-1 imp:n=0  $ The other world</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        c surfaces</span>
<span class="sd">        *1 pz  -0.5</span>
<span class="sd">        *2 pz  0.5</span>
<span class="sd">        3 cz  1.0</span>
<span class="sd">        ...</span>

<span class="sd">        &gt;&gt;&gt; m.bc[&#39;radial&#39;] = &#39;*&#39;</span>
<span class="sd">        &gt;&gt;&gt; print m        #doctest: +ELLIPSIS </span>
<span class="sd">        ...</span>
<span class="sd">        1 0  -1 imp:n=1  $ model</span>
<span class="sd">        2 0  1 imp:n=0  $ The other world</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        c surfaces</span>
<span class="sd">        *1 rcc  0.0  0.0  -0.5  0.0  0.0  1.0  1.0</span>
<span class="sd">        ...</span>

<span class="sd">        &gt;&gt;&gt; m.bc[&#39;radial&#39;] = &#39;+&#39;</span>
<span class="sd">        &gt;&gt;&gt; print m        #doctest: +ELLIPSIS </span>
<span class="sd">        ...</span>
<span class="sd">        1 0  -3 -2 1 imp:n=1  $ model</span>
<span class="sd">        2 0  3:2:-1 imp:n=0  $ The other world</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>
<span class="sd">        c surfaces</span>
<span class="sd">        *1 pz  -0.5</span>
<span class="sd">        *2 pz  0.5</span>
<span class="sd">        +3 cz  1.0</span>
<span class="sd">        ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bc</span>

    <span class="nd">@property</span></div>
    <span class="k">def</span> <span class="nf">gm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Link to the general model. This is the input data for the MCNP input</span>
<span class="sd">        file generated by the McnpInterface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span>

    <span class="nd">@gm.setter</span>
    <span class="k">def</span> <span class="nf">gm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<div class="viewcode-block" id="McnpInterface.gm"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface.gm">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_model</span><span class="p">()</span>
        <span class="n">s1</span> <span class="o">=</span>  <span class="nb">super</span><span class="p">(</span><span class="n">McnpInterface</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s1</span>

    
    <span class="k">def</span> <span class="nf">_process_tallies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># _LOG</span>

        <span class="c"># first, ensure to delete attributes from previous run:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;_element&#39;</span><span class="p">,</span> <span class="s">&#39;_rods&#39;</span><span class="p">,</span> <span class="s">&#39;_grid&#39;</span><span class="p">,</span> <span class="s">&#39;_tally&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span> <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">used</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;grid used in &#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">get_key</span><span class="p">()</span>
                <span class="n">validrods</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">heats</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;rod with heat: &#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_key</span><span class="p">(),</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">ijk</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">abspos</span><span class="p">()</span>
                    <span class="c"># r is an element having heat. Find how it is positioned</span>
                    <span class="c"># with respect to v:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span> <span class="n">r</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="c"># parents of r till v, including v</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;parents:&#39;</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pr</span><span class="p">):</span>
                            <span class="k">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">(),</span> <span class="n">p</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">ijk</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">indexed</span><span class="p">()</span>
                            <span class="k">print</span> <span class="n">r</span><span class="o">.</span><span class="n">abspos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">indexed</span><span class="p">():</span>
                        <span class="c"># the parent of r directly ineserted into v is indexed</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">abspos</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">car</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                            <span class="c"># and if r is not shifted with respect to the parent, directly</span>
                            <span class="c"># inserted into v</span>
                            <span class="n">validrods</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ijk</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                <span class="k">print</span> <span class="s">&#39;rod is valid&#39;</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;found {0} rods for gridmesh in grid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">validrods</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">validrods</span><span class="p">:</span>
                    <span class="c"># unify zmeshes for validrods</span>
                    <span class="n">r0</span> <span class="o">=</span> <span class="n">validrods</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">validrods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">r0</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">unify</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">heat</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">validrods</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">r0</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">unify</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">heat</span><span class="p">)</span>
                    <span class="c"># create meshtally</span>
                    <span class="n">mt</span> <span class="o">=</span> <span class="n">grid2tally</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">r0</span><span class="p">)</span>
                    <span class="n">mt</span><span class="o">.</span><span class="n">_rods</span> <span class="o">=</span> <span class="n">validrods</span>
                    <span class="n">mt</span><span class="o">.</span><span class="n">_grid</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;mesh tally</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">mt</span>
                    <span class="n">It</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
                    <span class="c"># label rods that they belong to the gridtally</span>
                    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">validrods</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">_tally</span> <span class="o">=</span> <span class="n">It</span>

        <span class="c"># add individual mesh tallies</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">heats</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">It</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">_tally</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">mt</span> <span class="o">=</span> <span class="n">zmesh2mtally</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">heat</span><span class="p">)</span>
                    <span class="n">mt</span><span class="o">.</span><span class="n">_element</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">It</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">_tally</span> <span class="o">=</span> <span class="n">It</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;Fmesh tally for &#39;</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">get_key</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">_tally</span>

        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;tally collection after _process_tallies:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span>



    <span class="k">def</span> <span class="nf">_process_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">_LOG</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;_process_model starts&#39;</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__uC</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># this is by default. No processing is necessary.</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;McnpInterface.gm must point to the root of a model&#39;</span><span class="p">)</span>

        <span class="c"># self.__pm = Sphere()</span>
        <span class="c"># self.__pm.R = self.__gm.get_radius(False) # False means circumfered radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span> <span class="o">=</span> <span class="n">Sphere</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="o">.</span><span class="n">circumscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="o">.</span><span class="n">__u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uC</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;copy of gm is generated&#39;</span>

        <span class="c"># planes above and below the model. Used to represent upper and lower</span>
        <span class="c"># layers of axial distributions:</span>
        <span class="n">Zmin</span><span class="p">,</span> <span class="n">Zmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__whole_volume</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="s">&#39;pz {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Zmin</span> <span class="o">-</span> <span class="mf">1000.</span><span class="p">))</span><span class="o">.</span><span class="n">volume</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_tallies</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;tallies generated&#39;</span>


        <span class="c"># if axial and radial bc are different, do not use macrobody for the model boundary:</span>
        <span class="c"># add surfaces that can contain reflective b.c. in advance:</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="p">()))</span> <span class="c"># element whose surfaaces can be reflective</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bc</span><span class="p">[</span><span class="s">&#39;axial&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bc</span><span class="p">[</span><span class="s">&#39;radial&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">ref</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">surfaceCollection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mcnp</span><span class="o">.</span><span class="n">surfaces</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;pz&#39;</span><span class="p">,</span> <span class="n">plst</span><span class="o">=</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">refl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__bc</span><span class="p">[</span><span class="s">&#39;axial&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surfaceCollection</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">solid2surface</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">refl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__bc</span><span class="p">[</span><span class="s">&#39;radial&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_interior</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pm</span><span class="o">.</span><span class="n">__u</span><span class="p">,</span> <span class="s">&#39;Container for model&#39;</span><span class="p">,</span> <span class="n">importance</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_model_time</span> <span class="o">=</span> <span class="n">time2</span> <span class="o">-</span> <span class="n">time1</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;{0} cells generated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_add_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">element_name</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">_LOG</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;_add_lattice &#39;</span><span class="p">,</span> <span class="n">element_name</span>
        <span class="c"># add the lattice cell</span>
        <span class="n">lcell</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Cell</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lcell</span><span class="p">)</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_material</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">element</span><span class="o">.</span><span class="n">get_value_by_index</span><span class="p">(</span><span class="s">&#39;temp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get_value_by_index</span><span class="p">(</span><span class="s">&#39;dens&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">lcell</span><span class="o">.</span><span class="n">mat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># if dens is zero, use material&#39;s density</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">lcell</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dens</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="o">-</span><span class="n">base_element2volume</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;imp:n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;lat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">cmt</span> <span class="o">=</span> <span class="s">&#39;Lattice cell for {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element_name</span><span class="p">)</span>
        <span class="c"># filling matrix:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="s">&#39;{0}:{1} {2}:{3} {4}:{5}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">element</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extension</span><span class="p">())</span>
        <span class="n">itypel</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">utd</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">utd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span> 
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">leb</span><span class="p">,</span> <span class="n">itype</span><span class="p">)</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">lattice_elements</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">itype</span> <span class="o">&gt;</span> <span class="n">it</span><span class="p">:</span>
                <span class="c"># leb was not previously defined.</span>
                <span class="n">unext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uC</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span> <span class="c"># setup new universe</span>
                <span class="n">utd</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">=</span> <span class="n">unext</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_interior</span><span class="p">(</span><span class="n">leb</span><span class="p">,</span> <span class="n">unext</span><span class="p">,</span> <span class="s">&#39;lattice element {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ijk</span><span class="p">))</span>
                <span class="c"># stack.append((leb, unext, &#39;{} {}&#39;.format(element_name, ijk)))</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">itype</span>
            <span class="n">itypel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itype</span><span class="p">)</span> 
            <span class="c"># print &#39; &#39;*16, &#39;{}&#39;.format(ijk)</span>
        <span class="k">for</span> <span class="n">itype</span> <span class="ow">in</span> <span class="n">itypel</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">+=</span> <span class="s">&#39; {0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utd</span><span class="p">[</span><span class="n">itype</span><span class="p">])</span>
        <span class="n">lcell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;added {0} lebs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">itypel</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;scheduled {0} leb interiors&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_interior</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_add_interior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">element_name</span><span class="p">,</span> <span class="n">importance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">_LOG</span>
        <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">used</span><span class="p">():</span>
            <span class="c"># element will be represented by a lattice cell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_lattice</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">element_name</span><span class="p">)</span>
                    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;_add_interior for &#39;</span><span class="p">,</span> <span class="n">element_name</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="c"># compute in advance some parameters of the children:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">__vol</span> <span class="o">=</span> <span class="n">solid2volume</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="n">Nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># add cells that describe containers of children:</span>
            <span class="k">for</span> <span class="n">Ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nc</span><span class="p">):</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">Ic</span><span class="p">]</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Cell</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="o">-</span><span class="n">child</span><span class="o">.</span><span class="n">__vol</span>
                <span class="k">for</span> <span class="n">Ioc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ic</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nc</span><span class="p">):</span>
                    <span class="n">ochild</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">Ioc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">ochild</span><span class="p">):</span>
                        <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&amp;</span> <span class="n">ochild</span><span class="o">.</span><span class="n">__vol</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;imp:n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">cmt</span> <span class="o">=</span> <span class="s">&#39;container for {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">is_constant</span><span class="p">(</span><span class="s">&#39;temp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">is_constant</span><span class="p">(</span><span class="s">&#39;dens&#39;</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_value_by_index</span><span class="p">(</span><span class="s">&#39;temp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_material</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get_value_by_index</span><span class="p">(</span><span class="s">&#39;dens&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">mat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c"># if density is zero, use material value</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dens</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;tmp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uC</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;fill&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_interior</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="c"># stack.append((child, fill, &#39;{} {}&#39;.format(element_name, child.name)))</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;added {0} children containers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Nc</span><span class="p">)</span>

            <span class="c"># add cells that describe axial distribution of temp and dens in element:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">_no_interior</span><span class="p">:</span>
                <span class="n">Nl</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="n">cc</span><span class="p">,</span> <span class="p">(</span><span class="n">isf</span><span class="p">,</span> <span class="n">isl</span><span class="p">))</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">layers</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">isf</span><span class="p">:</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="o">-</span><span class="n">mcnp</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;pz&#39;</span><span class="p">,</span> <span class="n">plst</span><span class="o">=</span><span class="p">[</span><span class="n">z1</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">isl</span><span class="p">:</span>
                        <span class="n">v2</span> <span class="o">=</span> <span class="o">-</span><span class="n">mcnp</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v2</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Volume</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;pz&#39;</span><span class="p">,</span> <span class="n">plst</span><span class="o">=</span><span class="p">[</span><span class="n">z2</span><span class="p">]))</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">&amp;</span> <span class="n">v2</span> 
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
                        <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">&amp;</span> <span class="n">c</span><span class="o">.</span><span class="n">__vol</span>
                    <span class="k">if</span> <span class="n">vol</span><span class="o">.</span><span class="n">is_universal</span><span class="p">():</span>
                        <span class="c"># this can be only if there is only one layer and there are</span>
                        <span class="c"># no children . </span>
                        <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__whole_volume</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Cell</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_material</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">material</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">mat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dens</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="o">-</span><span class="n">d</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;tmp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;imp:n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">importance</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">cmt</span> <span class="o">=</span> <span class="s">&#39;layer of {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">element_name</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">opt</span><span class="p">[</span><span class="s">&#39;u&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
                    <span class="n">Nl</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;added {0} layers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Nl</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="s">&#39;scheduled {0} children interiors&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_interior</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_material</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mname</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns instance of Material class for the string name mname</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;WARNING: material {0} not defined, will be replaced with default&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mcnp</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mdefa</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">dens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mdefd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mdict</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;T&#39;</span><span class="p">:</span><span class="n">T</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">m</span>

    <span class="k">def</span> <span class="nf">plot_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">XYopt</span><span class="o">=</span><span class="p">{},</span> <span class="n">XZopt</span><span class="o">=</span><span class="p">{},</span> <span class="n">YZopt</span><span class="o">=</span><span class="p">{}):</span>
<div class="viewcode-block" id="McnpInterface.plot_commands"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface.plot_commands">[docs]</a>        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        A multi-line string representing plot commands, which can be feed to MCNP to produce plots of</span>
<span class="sd">        the model.</span>

<span class="sd">        By dafault, commands for three plots are written: section by XY, XZ and</span>
<span class="sd">        YZ planes.</span>
<span class="sd">        </span>
<span class="sd">        element -- optional argument. If of one of solids type, its dimensions</span>
<span class="sd">        will be used to set extent of the plot.</span>
<span class="sd">        </span>
<span class="sd">        XYopt -- optional dictionary to provide user-defined options to the XY</span>
<span class="sd">        plot. For example, XYopt={&#39;ext&#39;:&#39;3.0 6.0&#39;}&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">element</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Sphere</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">R</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">R</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">R</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Box</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Y</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Z</span><span class="o">/</span><span class="mf">2.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Cylinder</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">R</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">R</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Z</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">X</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="n">Y</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="n">Z</span> <span class="o">*=</span> <span class="mf">1.1</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">abspos</span><span class="p">()</span><span class="o">.</span><span class="n">car</span>

        <span class="n">XYopt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">XYopt</span><span class="p">)</span>
        <span class="n">XZopt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">XZopt</span><span class="p">)</span>
        <span class="n">YZopt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">YZopt</span><span class="p">)</span>
        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;bas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bas&#39;</span><span class="p">,</span> <span class="s">&#39;1 0 0 0 1 0&#39;</span><span class="p">)</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;bas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bas&#39;</span><span class="p">,</span> <span class="s">&#39;1 0 0 0 0 1&#39;</span><span class="p">)</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;bas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;bas&#39;</span><span class="p">,</span> <span class="s">&#39;0 1 0 0 0 1&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dopt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">XYopt</span><span class="p">,</span> <span class="n">XZopt</span><span class="p">,</span> <span class="n">YZopt</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s">&#39;ext&#39;</span> <span class="ow">in</span> <span class="n">dopt</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">])</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="n">sss</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="n">sss</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="n">sss</span> <span class="o">=</span> <span class="n">sss</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="n">dopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sss</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ext&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ext&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Z</span><span class="p">))</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ext&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">))</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1} {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1} {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;or&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;{0} {1} {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mesh&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mesh&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mesh&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;lab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;0 0.3&#39;</span><span class="p">)</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;lab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;0 0.3&#39;</span><span class="p">)</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;lab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;0 0.3&#39;</span><span class="p">)</span>

        <span class="c"># Default colouring depends on presence in the original model non-uniform density meshes</span>
        <span class="n">def_color</span> <span class="o">=</span> <span class="s">&#39;by mat&#39;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">is_constant</span><span class="p">(</span><span class="s">&#39;dens&#39;</span><span class="p">):</span>
                <span class="n">def_color</span> <span class="o">=</span> <span class="s">&#39;by den&#39;</span>
                <span class="k">break</span>

        <span class="n">XYopt</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="n">def_color</span><span class="p">)</span>
        <span class="n">XZopt</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">XZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="n">def_color</span><span class="p">)</span>
        <span class="n">YZopt</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">YZopt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="n">def_color</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">opt_dict</span> <span class="ow">in</span> <span class="p">[</span><span class="n">XYopt</span><span class="p">,</span> <span class="n">XZopt</span><span class="p">,</span> <span class="n">YZopt</span><span class="p">]:</span>
            <span class="n">required_opts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;bas&#39;</span><span class="p">,</span> <span class="s">&#39;ext&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="s">&#39;lab&#39;</span><span class="p">,</span> <span class="s">&#39;sca&#39;</span><span class="p">,</span> <span class="s">&#39;color&#39;</span><span class="p">]</span>
            <span class="n">optional_opts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span><span class="n">opt_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_opts</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">required_opts</span> <span class="o">+</span> <span class="n">optional_opts</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;{0} {1} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">opt_dict</span><span class="p">[</span><span class="n">opt</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">78</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&#39; &amp;&#39;</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="n">s</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;end&#39;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_meshtal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meshtal</span><span class="o">=</span><span class="s">&#39;meshtal&#39;</span><span class="p">):</span></div>
<div class="viewcode-block" id="McnpInterface.read_meshtal"><a class="viewcode-back" href="../../../../pirs.hmcnp.html#pirs.hli.mcnp.interface.McnpInterface.read_meshtal">[docs]</a>        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads meshtall to the correspondent meshtallies and returns the copy of the general model containing read values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">meshtal</span><span class="p">)</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gm</span><span class="o">.</span><span class="n">copy_tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">rm</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">__ckey</span><span class="p">)</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">mt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rm</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></div>
        <span class="c"># if not continue, generate input file</span>
        <span class="c"># here the _process_model is called. So, this step must be before</span>
        <span class="c"># plot_commands.</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">inp</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;   MCNP input file generated in {0} seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_model_time</span><span class="p">)</span>

        <span class="c"># if plot mode, provide plot commands to the workplace</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;element&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_commands</span><span class="p">(</span><span class="n">element</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;   MCNP plotting commands generated&#39;</span>

        <span class="c"># if plot meshtally mode, provide plot commands in an external file:</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;z&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">exfile</span> <span class="o">=</span> <span class="s">&#39;commesh&#39;</span>

        <span class="c"># run the job</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># read meshtally</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gm</span> <span class="c"># .copy_tree()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="s">&#39;cCrR&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                <span class="c"># put computed results to the returned model.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">meshtal</span><span class="o">.</span><span class="n">exfile</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">tn</span><span class="p">,</span> <span class="n">tally</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># if _rods attribute is defines -- this is a grid tally containing results for all rods.</span>
                        <span class="n">rods</span> <span class="o">=</span> <span class="n">tally</span><span class="o">.</span><span class="n">_rods</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="c"># this is tally for single rod</span>
                        <span class="n">tally</span><span class="o">.</span><span class="n">_element</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">tally</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span> <span class="o">=</span> <span class="n">tally</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span> 
                        <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span> <span class="o">=</span> <span class="n">tally</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> 
                        <span class="n">Nx</span> <span class="o">=</span> <span class="n">imax</span> <span class="o">-</span> <span class="n">imin</span> <span class="o">+</span> <span class="mi">1</span> 
                        <span class="n">Ny</span> <span class="o">=</span> <span class="n">jmax</span> <span class="o">-</span> <span class="n">jmin</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">Nz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rods</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">get_grid</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">rods</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ijk</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">imin</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">jmin</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">Ny</span> <span class="o">+</span> <span class="n">j</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="n">tally</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">n</span><span class="o">*</span><span class="n">Nz</span><span class="p">:(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nz</span><span class="p">]</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                            <span class="c"># print &#39;heat set &#39;</span>
                            <span class="c"># print ijk, r.name, r.material, r.abspos()</span>
                            <span class="c"># print vals</span>
                        
                <span class="k">print</span> <span class="s">&#39;   MCNP run took {0} seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wp</span><span class="o">.</span><span class="n">run_time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># MCNP was not actually started. Put some values to the returned model.</span>
                <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
                <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                    <span class="n">mu</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
                    <span class="n">sd</span> <span class="o">=</span> <span class="n">mu</span><span class="o">*</span><span class="mf">0.3</span>
                    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">gauss</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">tally</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tallyCollection</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># if _rods defined -- this is a grid tally</span>
                        <span class="n">rods</span> <span class="o">=</span> <span class="n">tally</span><span class="o">.</span><span class="n">_rods</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="c"># this is tally for single solid.</span>
                        <span class="n">tally</span><span class="o">.</span><span class="n">_element</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">set_values_by_function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">ijk</span> <span class="ow">in</span> <span class="n">rods</span><span class="p">:</span>
                            <span class="n">r</span><span class="o">.</span><span class="n">heat</span><span class="o">.</span><span class="n">set_values_by_function</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">nm</span>
            



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span></div>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">PIRS manual 1.1a documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Anton Travleev.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>